<script src="https://d3js.org/d3.v7.min.js"></script>
<section id="viz-adoption" style="padding:40px 0;">
  <h2>EV Adoption Over Time</h2>
  <p>EV share of new car sales by region, animated like a bar race.</p>
  <svg id="ev-adoption-chart" width="800" height="450"></svg>
</section>
<script>
function initEVAdoptionChart() {
  const svg = d3.select("#ev-adoption-chart");
  const width = +svg.attr("width");
  const height = +svg.attr("height");
  const margin = { top: 40, right: 40, bottom: 40, left: 140 };
  const innerWidth = width - margin.left - margin.right;
  const innerHeight = height - margin.top - margin.bottom;

  const g = svg.append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

  // --- Synthetic data, replace with real EV adoption dataset ---
  const years = d3.range(2015, 2025);
  const regions = ["China", "Europe", "US", "Other"];

  let data = [];
  years.forEach(y => {
    data.push({ year: y, region: "China",  ev_share: Math.max(1, (y-2014)*2 + 5) });
    data.push({ year: y, region: "Europe", ev_share: Math.max(1, (y-2014)*1.8 + 4) });
    data.push({ year: y, region: "US",     ev_share: Math.max(1, (y-2014)*1.2 + 2) });
    data.push({ year: y, region: "Other",  ev_share: Math.max(0.5, (y-2014)*0.5 + 1) });
  });
  // --------------------------------------------------------------

  const allYears = [...new Set(data.map(d => d.year))].sort(d3.ascending);

  const x = d3.scaleLinear().range([0, innerWidth]);
  const y = d3.scaleBand().range([0, innerHeight]).padding(0.2);

  const color = d3.scaleOrdinal()
    .domain(regions)
    .range(["#1FBF74", "#3498DB", "#E67E22", "#9B59B6"]);

  const xAxisG = g.append("g")
    .attr("transform", `translate(0,${innerHeight})`)
    .attr("class", "x-axis");

  const yAxisG = g.append("g")
    .attr("class", "y-axis");

  const yearLabel = g.append("text")
    .attr("x", innerWidth)
    .attr("y", -10)
    .attr("text-anchor", "end")
    .style("font-size", "18px")
    .style("font-weight", "bold");

  function update(yearIndex) {
    const year = allYears[yearIndex % allYears.length];
    const yearData = data
      .filter(d => d.year === year)
      .sort((a, b) => d3.descending(a.ev_share, b.ev_share));

    x.domain([0, d3.max(yearData, d => d.ev_share) * 1.1]);
    y.domain(yearData.map(d => d.region));

    const bars = g.selectAll(".bar")
      .data(yearData, d => d.region);

    bars.enter()
      .append("rect")
      .attr("class", "bar")
      .attr("y", d => y(d.region))
      .attr("height", y.bandwidth())
      .attr("x", 0)
      .attr("width", 0)
      .attr("fill", d => color(d.region))
      .merge(bars)
      .transition()
      .duration(800)
      .attr("y", d => y(d.region))
      .attr("width", d => x(d.ev_share));

    bars.exit().remove();

    const labels = g.selectAll(".label")
      .data(yearData, d => d.region);

    labels.enter()
      .append("text")
      .attr("class", "label")
      .attr("y", d => y(d.region) + y.bandwidth() / 2 + 5)
      .attr("x", 5)
      .text(d => `${d.region} – ${d.ev_share.toFixed(1)}%`)
      .merge(labels)
      .transition()
      .duration(800)
      .attr("y", d => y(d.region) + y.bandwidth() / 2 + 5)
      .text(d => `${d.region} – ${d.ev_share.toFixed(1)}%`);

    labels.exit().remove();

    xAxisG.transition()
      .duration(800)
      .call(d3.axisBottom(x).ticks(5).tickFormat(d => d + "%"));

    yAxisG.transition()
      .duration(800)
      .call(d3.axisLeft(y));

    yearLabel.text(year);
  }

  // Expose a play function for scroll trigger
  let i = 0;
  let intervalId = null;
  window._playAdoptionRace = () => {
    if (intervalId !== null) return; // don't double-start
    update(i);
    intervalId = setInterval(() => {
      i = (i + 1) % allYears.length;
      update(i);
    }, 1600);
  };
}

// Scroll trigger
document.addEventListener("DOMContentLoaded", () => {
  initEVAdoptionChart();

  const section = document.querySelector("#viz-adoption");
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        if (window._playAdoptionRace) {
          window._playAdoptionRace();
        }
        observer.unobserve(section);
      }
    });
  }, { threshold: 0.4 });

  observer.observe(section);
});
</script>
