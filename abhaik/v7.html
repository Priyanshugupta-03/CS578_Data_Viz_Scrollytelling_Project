<script src="https://d3js.org/d3.v7.min.js"></script>
<section id="viz-compass" style="padding:40px 0;">
  <h2>Lifecycle Compass: Multi-Dimensional Comparison</h2>
  <svg id="compass-chart" width="500" height="500"></svg>
</section>
<script>
function initLifecycleCompass() {
  const svg = d3.select("#compass-chart");
  const width = +svg.attr("width");
  const height = +svg.attr("height");
  const radius = Math.min(width, height) / 2 - 60;
  const g = svg.append("g")
    .attr("transform", `translate(${width / 2},${height / 2})`);

  const factors = ["Manufacturing", "Use Phase", "End-of-life", "Energy dependency"];
  const angleSlice = (Math.PI * 2) / factors.length;

  // scores 0â€“10 (synthetic)
  const evScores = [8, 3, 5, 9];
  const iceScores = [4, 9, 5, 4];

  const rScale = d3.scaleLinear()
    .domain([0, 10])
    .range([0, radius]);

  // grid circles
  [2, 4, 6, 8, 10].forEach(v => {
    g.append("circle")
      .attr("r", rScale(v))
      .attr("fill", "none")
      .attr("stroke", "#ccc")
      .attr("stroke-dasharray", "2,2");
  });

  // axis lines + labels
  const axis = g.selectAll(".axis")
    .data(factors)
    .enter().append("g")
    .attr("class", "axis");

  axis.append("line")
    .attr("x1", 0)
    .attr("y1", 0)
    .attr("x2", (_, i) => rScale(10) * Math.cos(angleSlice * i - Math.PI / 2))
    .attr("y2", (_, i) => rScale(10) * Math.sin(angleSlice * i - Math.PI / 2))
    .attr("stroke", "#aaa");

  axis.append("text")
    .attr("x", (_, i) => (rScale(10) + 15) * Math.cos(angleSlice * i - Math.PI / 2))
    .attr("y", (_, i) => (rScale(10) + 15) * Math.sin(angleSlice * i - Math.PI / 2))
    .attr("text-anchor", "middle")
    .style("font-size", "11px")
    .text(d => d);

  function radarPath(scores) {
    const coords = scores.map((s, i) => {
      const angle = angleSlice * i - Math.PI / 2;
      return [
        rScale(s) * Math.cos(angle),
        rScale(s) * Math.sin(angle)
      ];
    });
    coords.push(coords[0]);
    return d3.line()(coords);
  }

  const evPath = g.append("path")
    .attr("fill", "#1FBF74")
    .attr("stroke", "#1FBF74")
    .attr("stroke-width", 2)
    .attr("fill-opacity", 0.2);

  const icePath = g.append("path")
    .attr("fill", "#C0392B")
    .attr("stroke", "#C0392B")
    .attr("stroke-width", 2)
    .attr("fill-opacity", 0.2);

  // start collapsed at center
  const zeroScores = [0, 0, 0, 0];
  evPath.attr("d", radarPath(zeroScores));
  icePath.attr("d", radarPath(zeroScores));

  g.append("text")
    .attr("x", -width / 2 + 20)
    .attr("y", -height / 2 + 20)
    .text("EV (green) vs ICE (red)");

  window._playCompass = () => {
    evPath.transition().duration(1000).attr("d", radarPath(evScores));
    icePath.transition().duration(1000).attr("d", radarPath(iceScores));
  };
}

document.addEventListener("DOMContentLoaded", () => {
  initLifecycleCompass();

  const section = document.querySelector("#viz-compass");
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting && window._playCompass) {
        window._playCompass();
        observer.unobserve(section);
      }
    });
  }, { threshold: 0.4 });

  observer.observe(section);
});
</script>
