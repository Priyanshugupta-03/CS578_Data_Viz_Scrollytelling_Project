<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
  body {
    margin: 0;
    background: #0f172a;
    font-family: system-ui, sans-serif;
    color: #e5e7eb;
  }

  #viz-compass {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 100px 16px;
  }

  .compass-card {
    max-width: 600px;
    width: 100%;
    padding: 24px;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.07);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 25px 60px rgba(0, 0, 0, 0.45);
    text-align: center;
  }

  .compass-title {
    font-size: 1.2rem;
    margin-bottom: 16px;
    opacity: 0.9;
  }

  #compass-chart {
    width: 100%;
    height: 500px;
    display: block;
  }

  .compass-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 16px;
    font-size: 0.9rem;
    color: #ddd;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .legend-color {
    width: 14px;
    height: 14px;
    border-radius: 999px;
    display: inline-block;
  }

  .legend-ev {
    background: #1FBF74;
  }

  .legend-ice {
    background: #C0392B;
  }
</style>

<section id="viz-compass">
  <div class="compass-card">
    <div class="compass-title">Lifecycle Compass: EV vs ICE</div>
    <svg id="compass-chart" viewBox="0 0 500 500" preserveAspectRatio="xMidYMid meet"></svg>
    <div class="compass-legend">
      <div class="legend-item"><span class="legend-color legend-ev"></span> EV</div>
      <div class="legend-item"><span class="legend-color legend-ice"></span> ICE</div>
    </div>
  </div>
</section>

<script>
function initLifecycleCompass() {
  const svg = d3.select("#compass-chart");
  const width = 500;
  const height = 500;
  const radius = Math.min(width, height) / 2 - 60;

  const g = svg.append("g")
    .attr("transform", `translate(${width / 2},${height / 2})`);

  const factors = ["Manufacturing", "Use Phase", "End-of-life", "Energy Dependency"];
  const angleSlice = (Math.PI * 2) / factors.length;

  const evScores = [8, 3, 5, 9];
  const iceScores = [4, 9, 5, 4];

  const rScale = d3.scaleLinear()
    .domain([0, 10])
    .range([0, radius]);

  [2, 4, 6, 8, 10].forEach(level => {
    g.append("circle")
      .attr("r", rScale(level))
      .attr("fill", "none")
      .attr("stroke", "#999")
      .attr("opacity", 0.2);
  });

  const axis = g.selectAll(".axis")
    .data(factors)
    .enter().append("g");

  axis.append("line")
    .attr("x1", 0).attr("y1", 0)
    .attr("x2", (_, i) => rScale(10) * Math.cos(angleSlice * i - Math.PI / 2))
    .attr("y2", (_, i) => rScale(10) * Math.sin(angleSlice * i - Math.PI / 2))
    .attr("stroke", "#aaa").attr("opacity", 0.4);

  axis.append("text")
    .attr("x", (_, i) => (rScale(10) + 16) * Math.cos(angleSlice * i - Math.PI / 2))
    .attr("y", (_, i) => (rScale(10) + 16) * Math.sin(angleSlice * i - Math.PI / 2))
    .attr("text-anchor", "middle")
    .style("fill", "#ddd")
    .style("font-size", "12px")
    .text(d => d);

  function radarPath(scores) {
    const points = scores.map((s, i) => {
      const angle = angleSlice * i - Math.PI / 2;
      return [
        rScale(s) * Math.cos(angle),
        rScale(s) * Math.sin(angle)
      ];
    });
    points.push(points[0]);
    return d3.line()(points);
  }

  const evPath = g.append("path")
    .attr("fill", "#1FBF74")
    .attr("stroke", "#1FBF74")
    .attr("stroke-width", 2)
    .attr("fill-opacity", 0.2);

  const icePath = g.append("path")
    .attr("fill", "#C0392B")
    .attr("stroke", "#C0392B")
    .attr("stroke-width", 2)
    .attr("fill-opacity", 0.2);

  const zero = [0, 0, 0, 0];
  evPath.attr("d", radarPath(zero));
  icePath.attr("d", radarPath(zero));

  function animateRadar() {
    evPath.transition().duration(1000).attr("d", radarPath(evScores));
    icePath.transition().duration(1000).attr("d", radarPath(iceScores));

    setTimeout(() => pulse(evPath, evScores), 1500);
    setTimeout(() => pulse(icePath, iceScores), 1800);
  }

  function pulse(path, baseScores) {
    const scale = 1.05;
    const alt = baseScores.map(v => v * scale);

    function loop() {
      path.transition().duration(1000).attr("d", radarPath(alt))
        .transition().duration(1000).attr("d", radarPath(baseScores))
        .on("end", loop);
    }
    loop();
  }

  const section = document.querySelector("#viz-compass");
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        animateRadar();
        observer.unobserve(section);
      }
    });
  }, { threshold: 0.5 });

  observer.observe(section);
}

document.addEventListener("DOMContentLoaded", initLifecycleCompass);
</script>
